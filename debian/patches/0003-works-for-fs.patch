From: Luca Dariz <luca.dariz@gmail.com>
Date: Sat, 12 Jan 2019 20:08:40 +0100
Subject: works for fs

wip kijack
wip net
---
 arch/lkl/Kconfig                    | 16 -------
 arch/lkl/Makefile                   |  7 +++
 arch/lkl/configs/gnu_defconfig      | 95 +++++++++++++++++++++++++++++++++++++
 arch/lkl/defconfig                  | 17 +++++++
 arch/lkl/scripts/headers_install.py | 19 ++++----
 lib/raid6/algos.c                   | 15 ++++++
 scripts/mod/file2alias.c            |  2 +-
 tools/lkl/Makefile.autoconf         |  2 +-
 tools/lkl/Targets                   |  2 +-
 tools/lkl/lib/hijack/hijack.c       |  6 +++
 tools/lkl/lib/hijack/xlate.c        | 37 +++++++++++++++
 tools/lkl/lib/posix-host.c          |  2 +-
 12 files changed, 192 insertions(+), 28 deletions(-)
 create mode 100644 arch/lkl/configs/gnu_defconfig

Index: linux/arch/lkl/Kconfig
===================================================================
--- linux.orig/arch/lkl/Kconfig
+++ linux/arch/lkl/Kconfig
@@ -22,23 +22,7 @@ config LKL
        select 64BIT if "$(OUTPUT_FORMAT)" = "elf64-littleaarch64"
        select NET
        select MULTIUSER
-       select INET
-       select IPV6
-       select IP_PNP
-       select IP_PNP_DHCP
-       select TCP_CONG_ADVANCED
-       select TCP_CONG_BBR
        select HIGH_RES_TIMERS
-       select NET_SCHED
-       select NET_SCH_FQ
-       select IP_MULTICAST
-       select IPV6_MULTICAST
-       select IP_MULTIPLE_TABLES
-       select IPV6_MULTIPLE_TABLES
-       select IP_ROUTE_MULTIPATH
-       select IPV6_ROUTE_MULTIPATH
-       select IP_ADVANCED_ROUTER
-       select IPV6_ADVANCED_ROUTER
        select ARCH_NO_COHERENT_DMA_MMAP
 
 config OUTPUT_FORMAT
Index: linux/arch/lkl/Makefile
===================================================================
--- linux.orig/arch/lkl/Makefile
+++ linux/arch/lkl/Makefile
@@ -22,6 +22,13 @@ else # e.g., FreeBSD
 NPROC=$(shell sysctl -n hw.ncpu)
 endif
 
+ifeq ($(shell uname -o),GNU)
+HOSTCFLAGS += -DPATH_MAX=4096
+HOST_EXTRACFLAGS += -DPATH_MAX=4096
+CFLAGS += -DPATH_MAX=4096
+KBUILD_DEFCONFIG := gnu_defconfig
+endif
+
 LDFLAGS_vmlinux += -r
 LKL_ENTRY_POINTS := lkl_start_kernel lkl_sys_halt lkl_syscall lkl_trigger_irq \
 	lkl_get_free_irq lkl_put_irq lkl_is_running lkl_bug lkl_printf
Index: linux/arch/lkl/configs/gnu_defconfig
===================================================================
--- /dev/null
+++ linux/arch/lkl/configs/gnu_defconfig
@@ -0,0 +1,95 @@
+# CONFIG_LOCALVERSION_AUTO is not set
+CONFIG_NO_HZ_IDLE=y
+# CONFIG_SYSFS_SYSCALL is not set
+CONFIG_KALLSYMS_USE_DATA_SECTION=y
+CONFIG_KALLSYMS_ALL=y
+# CONFIG_BASE_FULL is not set
+# CONFIG_FUTEX is not set
+# CONFIG_SIGNALFD is not set
+# CONFIG_TIMERFD is not set
+# CONFIG_AIO is not set
+# CONFIG_ADVISE_SYSCALLS is not set
+CONFIG_EMBEDDED=y
+# CONFIG_VM_EVENT_COUNTERS is not set
+# CONFIG_COMPAT_BRK is not set
+# CONFIG_BLK_DEV_BSG is not set
+#CONFIG_NET=y
+#CONFIG_INET=y
+# CONFIG_WIRELESS is not set
+# CONFIG_UEVENT_HELPER is not set
+# CONFIG_FW_LOADER is not set
+CONFIG_VIRTIO_BLK=y
+#CONFIG_NETDEVICES=y
+#CONFIG_VIRTIO_NET=y
+# CONFIG_ETHERNET is not set
+# CONFIG_WLAN is not set
+# CONFIG_VT is not set
+CONFIG_VIRTIO_MMIO=y
+CONFIG_VIRTIO_MMIO_CMDLINE_DEVICES=y
+CONFIG_EXT4_FS=y
+CONFIG_EXT4_FS_POSIX_ACL=y
+CONFIG_EXT4_FS_SECURITY=y
+#CONFIG_XFS_FS=y
+#CONFIG_XFS_POSIX_ACL=y
+#CONFIG_BTRFS_FS=y
+#CONFIG_BTRFS_FS_POSIX_ACL=y
+# CONFIG_FILE_LOCKING is not set
+# CONFIG_DNOTIFY is not set
+# CONFIG_INOTIFY_USER is not set
+CONFIG_VFAT_FS=y
+CONFIG_NLS_CODEPAGE_437=y
+CONFIG_NLS_CODEPAGE_737=y
+CONFIG_NLS_CODEPAGE_775=y
+CONFIG_NLS_CODEPAGE_850=y
+CONFIG_NLS_CODEPAGE_852=y
+CONFIG_NLS_CODEPAGE_855=y
+CONFIG_NLS_CODEPAGE_857=y
+CONFIG_NLS_CODEPAGE_860=y
+CONFIG_NLS_CODEPAGE_861=y
+CONFIG_NLS_CODEPAGE_862=y
+CONFIG_NLS_CODEPAGE_863=y
+CONFIG_NLS_CODEPAGE_864=y
+CONFIG_NLS_CODEPAGE_865=y
+CONFIG_NLS_CODEPAGE_866=y
+CONFIG_NLS_CODEPAGE_869=y
+CONFIG_NLS_CODEPAGE_936=y
+CONFIG_NLS_CODEPAGE_950=y
+CONFIG_NLS_CODEPAGE_932=y
+CONFIG_NLS_CODEPAGE_949=y
+CONFIG_NLS_CODEPAGE_874=y
+CONFIG_NLS_ISO8859_8=y
+CONFIG_NLS_CODEPAGE_1250=y
+CONFIG_NLS_CODEPAGE_1251=y
+CONFIG_NLS_ASCII=y
+CONFIG_NLS_ISO8859_1=y
+CONFIG_NLS_ISO8859_2=y
+CONFIG_NLS_ISO8859_3=y
+CONFIG_NLS_ISO8859_4=y
+CONFIG_NLS_ISO8859_5=y
+CONFIG_NLS_ISO8859_6=y
+CONFIG_NLS_ISO8859_7=y
+CONFIG_NLS_ISO8859_9=y
+CONFIG_NLS_ISO8859_13=y
+CONFIG_NLS_ISO8859_14=y
+CONFIG_NLS_ISO8859_15=y
+CONFIG_NLS_KOI8_R=y
+CONFIG_NLS_KOI8_U=y
+CONFIG_NLS_MAC_ROMAN=y
+CONFIG_NLS_MAC_CELTIC=y
+CONFIG_NLS_MAC_CENTEURO=y
+CONFIG_NLS_MAC_CROATIAN=y
+CONFIG_NLS_MAC_CYRILLIC=y
+CONFIG_NLS_MAC_GAELIC=y
+CONFIG_NLS_MAC_GREEK=y
+CONFIG_NLS_MAC_ICELAND=y
+CONFIG_NLS_MAC_INUIT=y
+CONFIG_NLS_MAC_ROMANIAN=y
+CONFIG_NLS_MAC_TURKISH=y
+CONFIG_NLS_UTF8=y
+CONFIG_HZ_100=y
+CONFIG_CRYPTO_ANSI_CPRNG=y
+CONFIG_PRINTK_TIME=y
+CONFIG_DEBUG_INFO=y
+CONFIG_DEBUG_INFO_REDUCED=y
+# CONFIG_ENABLE_WARN_DEPRECATED is not set
+# CONFIG_ENABLE_MUST_CHECK is not set
Index: linux/arch/lkl/defconfig
===================================================================
--- linux.orig/arch/lkl/defconfig
+++ linux/arch/lkl/defconfig
@@ -93,3 +93,20 @@ CONFIG_DEBUG_INFO=y
 CONFIG_DEBUG_INFO_REDUCED=y
 # CONFIG_ENABLE_WARN_DEPRECATED is not set
 # CONFIG_ENABLE_MUST_CHECK is not set
+
+CONFIG_INET=y
+CONFIG_IPV6=y
+CONFIG_IP_PNP=y
+CONFIG_IP_PNP_DHCP=y
+CONFIG_TCP_CONG_ADVANCED=y
+CONFIG_TCP_CONG_BBR=y
+CONFIG_NET_SCHED=y
+CONFIG_NET_SCH_FQ=y
+CONFIG_IP_MULTICAST=y
+CONFIG_IPV6_MULTICAST=y
+CONFIG_IP_MULTIPLE_TABLES=y
+CONFIG_IPV6_MULTIPLE_TABLES=y
+CONFIG_IP_ROUTE_MULTIPATH=y
+CONFIG_IPV6_ROUTE_MULTIPATH=y
+CONFIG_IP_ADVANCED_ROUTER=y
+CONFIG_IPV6_ADVANCED_ROUTER=y
Index: linux/arch/lkl/scripts/headers_install.py
===================================================================
--- linux.orig/arch/lkl/scripts/headers_install.py
+++ linux/arch/lkl/scripts/headers_install.py
@@ -185,11 +185,14 @@ def process_header(h):
     print("  REPLACE\t%s" % (out_dir + "/" + os.path.basename(h)))
     replace(h)
 
-p = multiprocessing.Pool(args.jobs)
-try:
-    p.map_async(process_header, headers).wait(999999)
-    p.close()
-except:
-    p.terminate()
-finally:
-    p.join()
+# p = multiprocessing.Pool(args.jobs)
+# try:
+#     p.map_async(process_header, headers).wait(999999)
+#     p.close()
+# except:
+#     p.terminate()
+# finally:
+#     p.join()
+
+for h in headers:
+    process_header(h)
Index: linux/lib/raid6/algos.c
===================================================================
--- linux.orig/lib/raid6/algos.c
+++ linux/lib/raid6/algos.c
@@ -159,6 +159,20 @@ static inline const struct raid6_calls *
 	const struct raid6_calls *const *algo;
 	const struct raid6_calls *best;
 
+#ifdef __GNU__
+#warning "Disabling RAID6 algo test because too slow. Using intx4."
+	best = &raid6_intx4;
+	(void)algo;
+	(void)start;
+	(void)stop;
+	(void)j0;
+	(void)j1;
+	(void)perf;
+	bestgenperf = 0;
+	bestxorperf = 0;
+	pr_info("raid6: disabling algo test on GNU/Hurd. Using intx4");
+#else
+
 	for (bestgenperf = 0, bestxorperf = 0, best = NULL, algo = raid6_algos; *algo; algo++) {
 		if (!best || (*algo)->prefer >= best->prefer) {
 			if ((*algo)->valid && !(*algo)->valid())
@@ -210,6 +224,7 @@ static inline const struct raid6_calls *
 				(perf*HZ) >> (20-16+RAID6_TIME_JIFFIES_LG2+1));
 		}
 	}
+#endif
 
 	if (best) {
 		pr_info("raid6: using algorithm %s gen() %ld MB/s\n",
Index: linux/scripts/mod/file2alias.c
===================================================================
--- linux.orig/scripts/mod/file2alias.c
+++ linux/scripts/mod/file2alias.c
@@ -58,7 +58,7 @@ struct devtable {
  * handling. The differnces in detail are:
  *  a) we have segments which have sections
  *  b) we need a API call to get the respective section symbols */
-#if defined(__MACH__)
+#if defined(__MACH__) && !defined(__GNU__)
 #include <mach-o/getsect.h>
 
 #define INIT_SECTION(name)  do {					\
Index: linux/tools/lkl/Makefile.autoconf
===================================================================
--- linux.orig/tools/lkl/Makefile.autoconf
+++ linux/tools/lkl/Makefile.autoconf
@@ -46,7 +46,7 @@ endef
 
 define posix_host
   $(call set_autoconf_var,POSIX,y)
-  $(call set_autoconf_var,VIRTIO_NET,y)
+  $(if $(call is_defined,__GNU__),,$(call set_autoconf_var,VIRTIO_NET,y))
   LDFLAGS += -pie
   CFLAGS += -fPIC -pthread
   SOSUF := .so
Index: linux/tools/lkl/Targets
===================================================================
--- linux.orig/tools/lkl/Targets
+++ linux/tools/lkl/Targets
@@ -21,5 +21,5 @@ LDLIBS_cptofs-$(LKL_HOST_CONFIG_NEEDS_LA
 
 progs-y += tests/boot
 progs-y += tests/disk
-progs-y += tests/net-test
+progs-y += tests/net-test ####
 
Index: linux/tools/lkl/lib/hijack/hijack.c
===================================================================
--- linux.orig/tools/lkl/lib/hijack/hijack.c
+++ linux/tools/lkl/lib/hijack/hijack.c
@@ -17,7 +17,9 @@
 #include <dlfcn.h>
 #include <sys/socket.h>
 #include <sys/select.h>
+#ifndef __GNU__
 #include <sys/epoll.h>
+#endif
 #include <stdint.h>
 #include <string.h>
 #include <fcntl.h>
@@ -32,6 +34,8 @@
 #include "xlate.h"
 #include "init.h"
 
+#define PF_PACKET 99
+
 static int is_lklfd(int fd)
 {
 	if (fd < LKL_FD_OFFSET)
@@ -323,6 +327,7 @@ int close(int fd)
 	return lkl_call(__lkl__NR_close, 1, fd);
 }
 
+#ifndef __GNU__
 HOST_CALL(epoll_create);
 int epoll_create(int size)
 {
@@ -540,6 +545,7 @@ int epoll_wait(int epfd, struct epoll_ev
 
 	return ret;
 }
+#endif
 
 int eventfd(unsigned int count, int flags)
 {
Index: linux/tools/lkl/lib/hijack/xlate.c
===================================================================
--- linux.orig/tools/lkl/lib/hijack/xlate.c
+++ linux/tools/lkl/lib/hijack/xlate.c
@@ -12,6 +12,7 @@
 
 long lkl_set_errno(long err)
 {
+
 	if (err >= 0)
 		return err;
 
@@ -142,6 +143,7 @@ long lkl_set_errno(long err)
 	case -LKL_EIDRM:
 		errno = EIDRM;
 		break;
+#ifndef __GNU__
 	case -LKL_ECHRNG:
 		errno = ECHRNG;
 		break;
@@ -187,6 +189,7 @@ long lkl_set_errno(long err)
 	case -LKL_EBFONT:
 		errno = EBFONT;
 		break;
+#endif
 	case -LKL_ENOSTR:
 		errno = ENOSTR;
 		break;
@@ -199,18 +202,21 @@ long lkl_set_errno(long err)
 	case -LKL_ENOSR:
 		errno = ENOSR;
 		break;
+#ifndef __GNU__
 	case -LKL_ENONET:
 		errno = ENONET;
 		break;
 	case -LKL_ENOPKG:
 		errno = ENOPKG;
 		break;
+#endif
 	case -LKL_EREMOTE:
 		errno = EREMOTE;
 		break;
 	case -LKL_ENOLINK:
 		errno = ENOLINK;
 		break;
+#ifndef __GNU__
 	case -LKL_EADV:
 		errno = EADV;
 		break;
@@ -220,21 +226,25 @@ long lkl_set_errno(long err)
 	case -LKL_ECOMM:
 		errno = ECOMM;
 		break;
+#endif
 	case -LKL_EPROTO:
 		errno = EPROTO;
 		break;
 	case -LKL_EMULTIHOP:
 		errno = EMULTIHOP;
 		break;
+#ifndef __GNU__
 	case -LKL_EDOTDOT:
 		errno = EDOTDOT;
 		break;
+#endif
 	case -LKL_EBADMSG:
 		errno = EBADMSG;
 		break;
 	case -LKL_EOVERFLOW:
 		errno = EOVERFLOW;
 		break;
+#ifndef __GNU__
 	case -LKL_ENOTUNIQ:
 		errno = ENOTUNIQ;
 		break;
@@ -259,15 +269,18 @@ long lkl_set_errno(long err)
 	case -LKL_ELIBEXEC:
 		errno = ELIBEXEC;
 		break;
+#endif
 	case -LKL_EILSEQ:
 		errno = EILSEQ;
 		break;
+#ifndef __GNU__
 	case -LKL_ERESTART:
 		errno = ERESTART;
 		break;
 	case -LKL_ESTRPIPE:
 		errno = ESTRPIPE;
 		break;
+#endif
 	case -LKL_EUSERS:
 		errno = EUSERS;
 		break;
@@ -358,6 +371,7 @@ long lkl_set_errno(long err)
 	case -LKL_ESTALE:
 		errno = ESTALE;
 		break;
+#ifndef __GNU__
 	case -LKL_EUCLEAN:
 		errno = EUCLEAN;
 		break;
@@ -373,18 +387,22 @@ long lkl_set_errno(long err)
 	case -LKL_EREMOTEIO:
 		errno = EREMOTEIO;
 		break;
+#endif
 	case -LKL_EDQUOT:
 		errno = EDQUOT;
 		break;
+#ifndef __GNU__
 	case -LKL_ENOMEDIUM:
 		errno = ENOMEDIUM;
 		break;
 	case -LKL_EMEDIUMTYPE:
 		errno = EMEDIUMTYPE;
 		break;
+#endif
 	case -LKL_ECANCELED:
 		errno = ECANCELED;
 		break;
+#ifndef __GNU__
 	case -LKL_ENOKEY:
 		errno = ENOKEY;
 		break;
@@ -397,18 +415,21 @@ long lkl_set_errno(long err)
 	case -LKL_EKEYREJECTED:
 		errno = EKEYREJECTED;
 		break;
+#endif
 	case -LKL_EOWNERDEAD:
 		errno = EOWNERDEAD;
 		break;
 	case -LKL_ENOTRECOVERABLE:
 		errno = ENOTRECOVERABLE;
 		break;
+#ifndef __GNU__
 	case -LKL_ERFKILL:
 		errno = ERFKILL;
 		break;
 	case -LKL_EHWPOISON:
 		errno = EHWPOISON;
 		break;
+#endif
 	}
 
 	return -1;
@@ -433,20 +454,25 @@ int lkl_soname_xlate(int soname)
 		return LKL_SO_SNDBUF;
 	case SO_RCVBUF:
 		return LKL_SO_RCVBUF;
+#ifndef __GNU__
 	case SO_SNDBUFFORCE:
 		return LKL_SO_SNDBUFFORCE;
 	case SO_RCVBUFFORCE:
 		return LKL_SO_RCVBUFFORCE;
+#endif
 	case SO_KEEPALIVE:
 		return LKL_SO_KEEPALIVE;
 	case SO_OOBINLINE:
 		return LKL_SO_OOBINLINE;
+#ifndef __GNU__
 	case SO_NO_CHECK:
 		return LKL_SO_NO_CHECK;
 	case SO_PRIORITY:
 		return LKL_SO_PRIORITY;
+#endif
 	case SO_LINGER:
 		return LKL_SO_LINGER;
+#ifndef __GNU__
 	case SO_BSDCOMPAT:
 		return LKL_SO_BSDCOMPAT;
 #ifdef SO_REUSEPORT
@@ -457,6 +483,7 @@ int lkl_soname_xlate(int soname)
 		return LKL_SO_PASSCRED;
 	case SO_PEERCRED:
 		return LKL_SO_PEERCRED;
+#endif
 	case SO_RCVLOWAT:
 		return LKL_SO_RCVLOWAT;
 	case SO_SNDLOWAT:
@@ -465,6 +492,7 @@ int lkl_soname_xlate(int soname)
 		return LKL_SO_RCVTIMEO;
 	case SO_SNDTIMEO:
 		return LKL_SO_SNDTIMEO;
+#ifndef __GNU__
 	case SO_SECURITY_AUTHENTICATION:
 		return LKL_SO_SECURITY_AUTHENTICATION;
 	case SO_SECURITY_ENCRYPTION_TRANSPORT:
@@ -481,8 +509,10 @@ int lkl_soname_xlate(int soname)
 		return LKL_SO_PEERNAME;
 	case SO_TIMESTAMP:
 		return LKL_SO_TIMESTAMP;
+#endif
 	case SO_ACCEPTCONN:
 		return LKL_SO_ACCEPTCONN;
+#ifndef __GNU__
 	case SO_PEERSEC:
 		return LKL_SO_PEERSEC;
 	case SO_PASSSEC:
@@ -499,6 +529,7 @@ int lkl_soname_xlate(int soname)
 		return LKL_SO_DOMAIN;
 	case SO_RXQ_OVFL:
 		return LKL_SO_RXQ_OVFL;
+#endif
 #ifdef SO_WIFI_STATUS
 	case SO_WIFI_STATUS:
 		return LKL_SO_WIFI_STATUS;
@@ -555,10 +586,12 @@ unsigned long lkl_ioctl_req_xlate(unsign
 		return LKL_SIOCGPGRP;
 	case SIOCATMARK:
 		return LKL_SIOCATMARK;
+#ifndef __GNU__
 	case SIOCGSTAMP:
 		return LKL_SIOCGSTAMP;
 	case SIOCGSTAMPNS:
 		return LKL_SIOCGSTAMPNS;
+#endif
 	}
 
 	/* TODO: asm/termios.h translations */
@@ -589,10 +622,12 @@ int lkl_fcntl_cmd_xlate(int cmd)
 		return LKL_F_SETOWN;
 	case F_GETOWN:
 		return LKL_F_GETOWN;
+#ifndef __GNU__
 	case F_SETSIG:
 		return LKL_F_SETSIG;
 	case F_GETSIG:
 		return LKL_F_GETSIG;
+#endif
 #ifndef LKL_CONFIG_64BIT
 	case F_GETLK64:
 		return LKL_F_GETLK64;
@@ -601,10 +636,12 @@ int lkl_fcntl_cmd_xlate(int cmd)
 	case F_SETLKW64:
 		return LKL_F_SETLKW64;
 #endif
+#ifndef __GNU__
 	case F_SETOWN_EX:
 		return LKL_F_SETOWN_EX;
 	case F_GETOWN_EX:
 		return LKL_F_GETOWN_EX;
+#endif
 	}
 
 	return cmd;
Index: linux/tools/lkl/lib/posix-host.c
===================================================================
--- linux.orig/tools/lkl/lib/posix-host.c
+++ linux/tools/lkl/lib/posix-host.c
@@ -304,7 +304,7 @@ static void panic(void)
 
 static long _gettid(void)
 {
-#ifdef	__FreeBSD__
+#if defined(__FreeBSD__) || defined(__GNU__)
 	return (long)pthread_self();
 #else
 	return syscall(SYS_gettid);
